<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Guia de Prescrições PWA</title>
    
    <!-- Meta Tags PWA -->
    <meta name="theme-color" content="#18181b">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="HelpClin">
    <link rel="apple-touch-icon" href="https://placehold.co/192x192/18181b/ffffff?text=Rx">
    <link rel="manifest" href="manifest.json">

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Carrega a base de dados local para a migração inicial e modo de fallback -->
    <script src="database.js"></script>

    <script type="module">
        // Importa as bibliotecas do Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, addDoc, serverTimestamp, writeBatch, query, where, getDocs, orderBy } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Variáveis globais da aplicação
        let db, auth;
        let isFirebaseConnected = false;

        // Função para obter a configuração do Firebase a partir da função segura no Netlify
        async function getFirebaseConfigFromServer() {
            console.log("Passo 2: A obter a configuração do Firebase a partir de /api/config...");
            const response = await fetch('/api/config');
            if (!response.ok) {
                const errorText = await response.text();
                throw new Error(`Falha ao obter configuração do servidor. Status: ${response.status}. Detalhes: ${errorText}`);
            }
            const config = await response.json();
            if(!config.apiKey) throw new Error("A configuração recebida do servidor é inválida.");
            return config;
        }

        // Função para inicializar o Firebase
        async function initializeFirebase(config) {
            return new Promise((resolve, reject) => {
                try {
                    const app = initializeApp(config);
                    db = getFirestore(app);
                    auth = getAuth(app);
                    
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                             console.log("Passo 3: Firebase Autenticado com UID:", user.uid);
                             resolve();
                        } else {
                            try {
                                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                                    await signInWithCustomToken(auth, __initial_auth_token);
                                } else {
                                    await signInAnonymously(auth);
                                }
                            } catch (authError) {
                                reject(authError);
                            }
                        }
                    });
                } catch (initError) {
                    reject(initError);
                }
            });
        }
        
        // Evento que inicia a aplicação quando a página carrega
        window.addEventListener('load', async () => {
            console.log("Passo 1: A página foi carregada. A iniciar o aplicativo.");
            if ('serviceWorker' in navigator) {
                try {
                    await navigator.serviceWorker.register('/sw.js');
                    console.log('LOG: Service Worker registado com sucesso.');
                } catch (error) {
                    console.error('ERRO: Falha no registo do ServiceWorker: ', error);
                }
            }

            try {
                let finalFirebaseConfig;
                // Tenta obter a configuração da variável de ambiente de desenvolvimento primeiro
                if (typeof __firebase_config !== 'undefined' && __firebase_config) {
                    console.log("LOG: A usar a configuração do Firebase do ambiente de desenvolvimento.");
                    finalFirebaseConfig = JSON.parse(__firebase_config);
                } else {
                    // Se não estiver em desenvolvimento, obtém do servidor Netlify
                    finalFirebaseConfig = await getFirebaseConfigFromServer();
                }

                await initializeFirebase(finalFirebaseConfig);
                isFirebaseConnected = true;
                console.log("SUCESSO: Firebase inicializado. A iniciar o aplicativo principal em modo online.");
            } catch (error) {
                // Se a inicialização do Firebase falhar, ativa o modo de fallback
                console.warn("AVISO: Falha ao iniciar o Firebase. A ativar o modo de fallback com dados locais.", error);
                isFirebaseConnected = false;
                const errorDiv = document.getElementById('error-banner');
                errorDiv.innerText = "Falha na conexão com a nuvem. A usar dados locais (modo offline).";
                errorDiv.classList.remove('hidden');
            }
            
            // Inicia a aplicação principal, seja qual for o modo
            await mainApp();
        });

        // Função principal que contém toda a lógica da aplicação
        async function mainApp() {
            console.log(`Passo 4: A iniciar a lógica principal do aplicativo (Modo Online: ${isFirebaseConnected}).`);
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('main-content');
            const menuToggle = document.getElementById('menu-toggle');
            const searchBar = document.getElementById('search-bar');
            const specialtiesNav = document.getElementById('specialties-nav');
            const contentDisplay = document.getElementById('content-display');
            const fichaVerdeBtn = document.getElementById('ficha-verde-btn');
            const fichaVermelhaBtn = document.getElementById('ficha-vermelha-btn');
            const geminiModal = document.getElementById('gemini-modal');
            const geminiModalClose = document.getElementById('gemini-modal-close');
            const geminiModalTitle = document.getElementById('gemini-modal-title');
            const geminiLoading = document.getElementById('gemini-loading');
            const geminiResult = document.getElementById('gemini-result');
            const addModuleBtn = document.getElementById('add-module-btn');
            const addModuleModal = document.getElementById('add-module-modal');
            const closeModuleModalBtn = document.getElementById('close-module-modal');
            const saveModuleBtn = document.getElementById('save-module-btn');
            const migrationStatus = document.getElementById('migration-status');

            let currentFicha = 'verde';
            let currentSpecialty = null;
            let currentCondition = null;
            let isSidebarOpen = false;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const textModel = 'gemini-2.5-flash-preview-05-20';

            // --- Lógica de Fallback ---
            if (!isFirebaseConnected) {
                addModuleBtn.style.display = 'none'; // Esconde o botão de adicionar módulo
            }

            async function migrateDatabaseToFirestore() {
                if (!isFirebaseConnected) {
                    console.log("LOG: Modo offline. A saltar a migração para o Firestore.");
                    return;
                }
                
                const migrationKey = `db_migrated_${appId}_v3`;
                const migrationDone = await getDoc(doc(db, `artifacts/${appId}/public/data/migrations`, migrationKey));
                
                if (migrationDone.exists()) {
                    console.log("LOG: Migração da base de dados já foi concluída.");
                    return;
                }
                
                migrationStatus.classList.remove('hidden');
                migrationStatus.innerText = 'Inicializando banco de dados na nuvem... Isso pode levar um minuto.';
                console.log("LOG: A iniciar a migração da base de dados para o Firestore...");

                try {
                    const batch = writeBatch(db);
                    
                    for (const ficha in prescrevendoData) {
                        for (const specialty in prescrevendoData[ficha]) {
                            for (const condition in prescrevendoData[ficha][specialty]) {
                                const data = prescrevendoData[ficha][specialty][condition];
                                const docRef = doc(collection(db, `artifacts/${appId}/public/data/prescriptions`));
                                batch.set(docRef, {
                                    ficha,
                                    specialty,
                                    condition,
                                    content: data.content,
                                    prescriptions: data.prescricoes || [],
                                    isCustom: false,
                                    createdAt: serverTimestamp()
                                });
                            }
                        }
                    }
                    
                    const migrationDocRef = doc(db, `artifacts/${appId}/public/data/migrations`, migrationKey);
                    batch.set(migrationDocRef, { completedAt: serverTimestamp() });

                    await batch.commit();
                    console.log("SUCESSO: Migração da base de dados concluída!");
                    migrationStatus.innerText = 'Banco de dados inicializado com sucesso!';
                    setTimeout(() => migrationStatus.classList.add('hidden'), 3000);
                } catch (error) {
                    console.error("ERRO: Falha na migração da base de dados:", error);
                    migrationStatus.innerText = 'Falha ao inicializar o banco de dados. Tente recarregar a página.';
                }
            }
            
            async function getSpecialties(ficha) {
                if (isFirebaseConnected) {
                    const prescriptionsCol = collection(db, `artifacts/${appId}/public/data/prescriptions`);
                    const q = query(prescriptionsCol, where("ficha", "==", ficha), where("isCustom", "==", false));
                    const snapshot = await getDocs(q);
                    const specialties = new Set();
                    snapshot.forEach(doc => specialties.add(doc.data().specialty));
                    return Array.from(specialties).sort();
                } else {
                    // Fallback: Usa os dados do ficheiro database.js
                    return Object.keys(prescrevendoData[ficha] || {}).sort();
                }
            }

            async function getConditions(ficha, specialty) {
                 if (isFirebaseConnected) {
                     const prescriptionsCol = collection(db, `artifacts/${appId}/public/data/prescriptions`);
                     const q = query(prescriptionsCol, where("ficha", "==", ficha), where("specialty", "==", specialty), where("isCustom", "==", false), orderBy("condition"));
                     const snapshot = await getDocs(q);
                     return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                 } else {
                    // Fallback: Usa os dados do ficheiro database.js
                    const conditionsData = prescrevendoData[ficha]?.[specialty] || {};
                    return Object.keys(conditionsData).map(conditionKey => ({
                        id: `${ficha}-${specialty}-${conditionKey}`, // ID Falso para uso local
                        condition: conditionKey,
                        ...conditionsData[conditionKey]
                    })).sort((a,b) => a.condition.localeCompare(b.condition));
                 }
            }
            
            async function getCustomSpecialties() {
                if (!isFirebaseConnected) return []; // Módulos personalizados só funcionam online
                const prescriptionsCol = collection(db, `artifacts/${appId}/public/data/prescriptions`);
                const q = query(prescriptionsCol, where("isCustom", "==", true));
                const snapshot = await getDocs(q);
                const specialties = new Set();
                snapshot.forEach(doc => specialties.add(doc.data().specialty));
                return Array.from(specialties).sort();
            }

            async function getCustomConditions(specialty) {
                if (!isFirebaseConnected) return []; // Módulos personalizados só funcionam online
                const prescriptionsCol = collection(db, `artifacts/${appId}/public/data/prescriptions`);
                const q = query(prescriptionsCol, where("isCustom", "==", true), where("specialty", "==", specialty), orderBy("condition"));
                const snapshot = await getDocs(q);
                return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            }

            async function getConditionByDocId(docId) {
                if (isFirebaseConnected) {
                    const docRef = doc(db, `artifacts/${appId}/public/data/prescriptions`, docId);
                    const docSnap = await getDoc(docRef);
                    return docSnap.exists() ? { id: docSnap.id, ...docSnap.data() } : null;
                } else {
                    // Fallback: Procura a condição no objeto local (isto é simplificado)
                    const [ficha, specialty, conditionKey] = docId.split('-');
                    if (prescrevendoData[ficha]?.[specialty]?.[conditionKey]) {
                        return { id: docId, condition: conditionKey, ficha, specialty, ...prescrevendoData[ficha][specialty][conditionKey] };
                    }
                    return null;
                }
            }
            
            function showGeminiModal(title) {
                geminiModalTitle.innerHTML = `<span class="mr-2 text-xl">✨</span> ${title}`;
                geminiResult.innerHTML = '';
                geminiLoading.classList.remove('hidden');
                geminiModal.classList.remove('hidden');
            }

            function hideGeminiModal() {
                geminiModal.classList.add('hidden');
            }
            
            function getCacheKey(type) {
                if (!currentCondition) return null;
                return `geminiCache_${currentCondition.id}_${type}`;
            }

            async function getFromCache(key) {
                 if (!isFirebaseConnected || !auth.currentUser) return null;
                try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/geminiCache`, key);
                    const docSnap = await getDoc(docRef);
                    return docSnap.exists() ? docSnap.data().response : null;
                } catch (error) {
                    console.error("Erro ao buscar do cache do Firestore:", error);
                    return null;
                }
            }

            async function saveToCache(key, data) {
                 if (!isFirebaseConnected || !auth.currentUser) return;
                 try {
                    const docRef = doc(db, `artifacts/${appId}/public/data/geminiCache`, key);
                    await setDoc(docRef, { response: data, timestamp: serverTimestamp() });
                } catch (error) {
                    console.error("Erro ao salvar no cache do Firestore:", error);
                }
            }

            function markdownToHtml(text) {
                let html = text
                    .replace(/^### (.*$)/gim, '<h3 class="text-xl font-semibold text-gray-100 mt-6 mb-2 pb-2 border-b border-gray-700">$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2 class="text-2xl font-bold text-white mt-8 mb-3 pb-2 border-b-2 border-emerald-500">$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1 class="text-3xl font-bold text-white mt-10 mb-4">$1</h1>')
                    .replace(/\*\*(.*?)\*\*/g, '<strong class="text-white">$1</strong>')
                    .replace(/\*(.*?)\*/g, '<em>$1</em>')
                    .replace(/^- (.*$)/gim, '<li>$1</li>')
                    .replace(/^\* (.*$)/gim, '<li>$1</li>');
            
                html = html.replace(/(<li>(.|\n)*?<\/li>)/gm, (match) => {
                    return `<ul class="list-disc pl-5 space-y-2 my-4">${match.replace(/<\/li>\n<li>/g, '</li><li>')}</ul>`;
                });

                html = html.split('\n').map(p => p.trim()).filter(p => p.length > 0).map(p => {
                    if (p.startsWith('<h') || p.startsWith('<ul') || p.startsWith('<li')) return p;
                    return `<p class="leading-relaxed mb-4">${p}</p>`;
                }).join('');

                return html;
            }

            async function callProxyAPI(endpoint, bodyPayload) {
                 const proxyUrl = `/api/${endpoint}`; 
                 try { 
                    const response = await fetch(proxyUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(bodyPayload) }); 
                    if (!response.ok) { 
                        const errorData = await response.json().catch(() => ({error: "Erro desconhecido no servidor."})); 
                        throw new Error(errorData.error || `Erro ${response.status}: ${response.statusText}`); 
                    } 
                    return await response.json(); 
                 } catch (error) { 
                    console.error(`Falha na chamada do Proxy para ${endpoint}:`, error); 
                    throw error;
                 }
            }
           
            async function callGeminiAPI(prompt, systemInstruction, useGrounding = false, forceNew = false) {
                if (!isFirebaseConnected) {
                     geminiResult.innerHTML = `<p class="text-yellow-400">Funcionalidade indisponível em modo offline.</p>`;
                     geminiLoading.classList.add('hidden');
                     return;
                }
                const cacheKey = getCacheKey(systemInstruction.substring(0, 10));
                if (!forceNew) {
                    const cachedData = await getFromCache(cacheKey);
                    if (cachedData) {
                        console.log("Resposta carregada do cache do Firestore.");
                        geminiResult.innerHTML = cachedData.content + cachedData.sources;
                        geminiResult.innerHTML += `<button id="regenerate-btn" class="gemini-btn mt-6 w-full">Gerar Novamente</button>`;
                        document.getElementById('regenerate-btn').onclick = () => callGeminiAPI(prompt, systemInstruction, useGrounding, true);
                        geminiLoading.classList.add('hidden');
                        return;
                    }
                }

                const body = { prompt, systemInstruction, useGrounding, model: textModel }; 
                try { 
                    const result = await callProxyAPI('gemini', body); 
                    const candidate = result.candidates?.[0]; 
                    if (candidate?.content?.parts?.[0]?.text) { 
                        let sourcesHTML = ''; 
                        if (useGrounding && candidate.groundingMetadata?.groundingAttributions) { 
                            const sources = candidate.groundingMetadata.groundingAttributions.map(attr => attr.web).filter(web => web?.uri && web?.title); 
                            if (sources.length > 0) { 
                                sourcesHTML = '<h4 class="text-md font-semibold mt-8 mb-2 text-gray-400">Fontes:</h4><ul class="list-disc pl-5 text-sm space-y-1">'; 
                                sources.forEach(source => { sourcesHTML += `<li><a href="${source.uri}" target="_blank" rel="noopener noreferrer" class="text-emerald-400 hover:underline">${source.title}</a></li>`; }); 
                                sourcesHTML += '</ul>'; 
                            } 
                        } 
                        const rawText = candidate.content.parts[0].text; 
                        const htmlContent = markdownToHtml(rawText); 
                        const finalHtml = { content: htmlContent, sources: sourcesHTML }; 
                        geminiResult.innerHTML = finalHtml.content + finalHtml.sources; 
                        if (cacheKey) saveToCache(cacheKey, finalHtml); 
                    } else { 
                        throw new Error(candidate?.finishReason || "Resposta inválida da API."); 
                    } 
                } catch (error) { 
                    geminiResult.innerHTML = `<p class="text-red-400"><b>Ocorreu um erro:</b> ${error.message}</p><p class="text-xs text-zinc-400 mt-2">Por favor, verifique os logs no Netlify para mais detalhes.</p>`; 
                } finally { 
                    geminiLoading.classList.add('hidden'); 
                }
            }

            function renderConditionDetails(conditionDoc) {
                currentSpecialty = conditionDoc.specialty;
                currentCondition = conditionDoc;
                localStorage.setItem('lastView', JSON.stringify({ docId: conditionDoc.id, ficha: conditionDoc.ficha, isCustom: conditionDoc.isCustom }));
                
                const allPrescriptions = conditionDoc.prescriptions || [];
                const isCustom = conditionDoc.isCustom;
                
                let prescriptionsHTML = '';
                if (allPrescriptions.length > 0) {
                    allPrescriptions.forEach(p => {
                        prescriptionsHTML += `
                            <div class="mb-6 bg-zinc-800/50 p-4 rounded-lg border border-zinc-700">
                                <h4 class="text-lg font-semibold text-emerald-400 mb-2">${p.title}</h4>
                                <ol class="list-decimal list-inside space-y-2 text-gray-300">
                                    ${p.items.map(item => `<li>${item}</li>`).join('')}
                                </ol>
                            </div>
                        `;
                    });
                } else if (!isCustom) {
                     prescriptionsHTML = '<p class="text-gray-400">Nenhuma prescrição específica listada.</p>';
                }

                const geminiFeaturesHTML = (isCustom || !isFirebaseConnected) ? '' : `
                    <div class="mt-10 pt-6 border-t border-zinc-700">
                        <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                            <span class="mr-2 text-2xl">✨</span> Funções com Gemini
                        </h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <button class="gemini-btn" id="summarize-btn">Resumir Condição</button>
                            <button class="gemini-btn" id="patient-instructions-btn">Gerar Instruções para Paciente</button>
                        </div>
                    </div>
                `;

                const contentHTML = markdownToHtml(conditionDoc.content || 'Nenhum conteúdo adicional.');

                const referencesHTML = isCustom ? '' : `
                    <div class="mt-8 text-sm">
                        <h4 class="font-semibold text-gray-400">Referências e Leitura Adicional</h4>
                        <ul class="list-disc pl-5 mt-2 space-y-1">
                            <li><a href="https://www.uptodate.com/contents/search?search=${encodeURIComponent(conditionDoc.condition)}" target="_blank" rel="noopener noreferrer" class="text-emerald-400 hover:underline">Pesquisar "${conditionDoc.condition}" no UpToDate</a></li>
                        </ul>
                    </div>
                `;

                contentDisplay.innerHTML = `
                    <div class="flex">
                        <div class="w-full lg:w-2/3 pr-0 lg:pr-8">
                            <button id="back-btn" class="text-emerald-400 hover:text-emerald-300 mb-6 text-sm">&larr; Voltar para ${conditionDoc.specialty}</button>
                            <h2 class="text-4xl font-bold text-white mb-2">${conditionDoc.condition}</h2>
                            <p class="text-gray-400 mb-8">Especialidade: ${conditionDoc.specialty}</p>
                            ${contentHTML}
                            ${prescriptionsHTML}
                            ${geminiFeaturesHTML}
                        </div>
                        <div class="hidden lg:block w-1/3 pl-8 border-l border-zinc-700">
                            <h3 class="text-lg font-semibold text-white mb-4">Informações Adicionais</h3>
                            <div id="gemini-info-panel" class="bg-zinc-900/50 p-4 rounded-lg space-y-2 text-sm">
                                <p class="text-gray-400">Use as funções do Gemini para obter resumos e instruções.</p>
                            </div>
                            ${referencesHTML}
                        </div>
                    </div>
                `;
                
                if (!isCustom && isFirebaseConnected) {
                    document.getElementById('summarize-btn').addEventListener('click', () => {
                        showGeminiModal(`Resumo sobre ${conditionDoc.condition}`);
                        const prompt = `Forneça um resumo conciso e atualizado sobre a condição médica "${conditionDoc.condition}", abordando etiologia, apresentação clínica principal, diagnóstico diferencial e manejo geral. A resposta deve ser em português do Brasil e formatada em markdown.`;
                        const systemInstruction = "Você é um assistente médico. Forneça informações claras e objetivas para profissionais de saúde.";
                        callGeminiAPI(prompt, systemInstruction, true);
                    });

                    document.getElementById('patient-instructions-btn').addEventListener('click', () => {
                        showGeminiModal(`Instruções para Paciente: ${conditionDoc.condition}`);
                        const prompt = `Crie um texto explicativo para um paciente sobre a condição "${conditionDoc.condition}" e como seguir o tratamento prescrito. Use uma linguagem simples, clara, e evite jargões médicos. Explique a importância de seguir as orientações. A resposta deve ser em português do Brasil e formatada em markdown.`;
                        const systemInstruction = "Você é um assistente de comunicação em saúde. Fale de forma empática e clara para pacientes.";
                        callGeminiAPI(prompt, systemInstruction, false);
                    });
                }

                document.getElementById('back-btn').addEventListener('click', () => renderConditions(conditionDoc.specialty, isCustom));
                window.scrollTo(0, 0);
            }

            async function renderConditions(specialtyKey, isCustom = false) {
                currentSpecialty = specialtyKey;
                localStorage.setItem('lastView', JSON.stringify({ specialty: specialtyKey, ficha: currentFicha, isCustom }));
                
                const conditions = isCustom ? await getCustomConditions(specialtyKey) : await getConditions(currentFicha, specialtyKey);
                
                contentDisplay.innerHTML = `
                    <button id="back-to-specialties-btn" class="text-emerald-400 hover:text-emerald-300 mb-6 text-sm">&larr; Voltar para Especialidades</button>
                    <h2 class="text-3xl font-bold text-white mb-6">${specialtyKey}</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${conditions.map(condition => `
                            <div class="condition-card bg-zinc-700/50 hover:bg-zinc-700 p-4 rounded-lg cursor-pointer transition-all duration-200 border border-zinc-600 hover:border-emerald-500" data-doc-id="${condition.id}">
                                <h3 class="font-semibold text-lg text-white">${condition.condition}</h3>
                            </div>
                        `).join('')}
                    </div>
                `;

                document.querySelectorAll('.condition-card').forEach(card => {
                    card.addEventListener('click', async () => {
                        const conditionDoc = await getConditionByDocId(card.dataset.docId);
                        if(conditionDoc) renderConditionDetails(conditionDoc);
                    });
                });
                document.getElementById('back-to-specialties-btn').addEventListener('click', () => renderSpecialties(currentFicha));
            }
            
            async function renderSpecialties(ficha) {
                currentSpecialty = null;
                currentCondition = null;
                localStorage.setItem('lastView', JSON.stringify({ ficha }));
                
                const specialties = await getSpecialties(ficha);
                const customSpecialties = await getCustomSpecialties();
                
                let specialtiesHTML = specialties.map(s => `
                    <a href="#" class="specialty-link block py-2 px-3 rounded-md hover:bg-zinc-700" data-specialty="${s}" data-custom="false">${s}</a>
                `).join('');
                
                let customSpecialtiesHTML = customSpecialties.map(s => `
                    <a href="#" class="specialty-link block py-2 px-3 rounded-md hover:bg-zinc-700" data-specialty="${s}" data-custom="true">${s}</a>
                `).join('');

                let finalHTML = '';
                if (specialties.length > 0) {
                     finalHTML += `<h3 class="text-sm font-semibold text-gray-400 mt-4 mb-2 px-3 uppercase">Guias (${ficha})</h3>${specialtiesHTML}`;
                }
                 if (customSpecialties.length > 0) {
                    finalHTML += `<h3 class="text-sm font-semibold text-gray-400 mt-6 mb-2 px-3 uppercase">Meus Módulos</h3>${customSpecialtiesHTML}`;
                }

                specialtiesNav.innerHTML = finalHTML;
                contentDisplay.innerHTML = `<div class="text-center text-gray-400 mt-16"><h2 class="text-2xl">Selecione uma especialidade</h2><p>Escolha um item no menu à esquerda para começar.</p></div>`;

                document.querySelectorAll('.specialty-link').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const isCustom = e.target.dataset.custom === 'true';
                        renderConditions(e.target.dataset.specialty, isCustom);
                        if (isSidebarOpen) toggleSidebar();
                    });
                });
            }
            
            async function filterAndRenderSearch(query) {
                if (query.length < 2) {
                    renderSpecialties(currentFicha);
                    return;
                }
                
                let results = [];
                const lowerCaseQuery = query.toLowerCase();

                if (isFirebaseConnected) {
                    const prescriptionsCol = collection(db, `artifacts/${appId}/public/data/prescriptions`);
                    const snapshot = await getDocs(prescriptionsCol);
                    results = snapshot.docs
                        .map(doc => ({ id: doc.id, ...doc.data() }))
                        .filter(doc => doc.condition.toLowerCase().includes(lowerCaseQuery) || doc.specialty.toLowerCase().includes(lowerCaseQuery));
                } else {
                     for (const ficha in prescrevendoData) {
                        for (const specialty in prescrevendoData[ficha]) {
                            for (const condition in prescrevendoData[ficha][specialty]) {
                                 if (condition.toLowerCase().includes(lowerCaseQuery) || specialty.toLowerCase().includes(lowerCaseQuery)) {
                                    results.push({
                                        id: `${ficha}-${specialty}-${condition}`,
                                        condition,
                                        specialty,
                                        ficha,
                                        isCustom: false
                                    });
                                }
                            }
                        }
                    }
                }

                if (results.length > 0) {
                    contentDisplay.innerHTML = `
                        <h2 class="text-3xl font-bold text-white mb-6">Resultados da busca para "${query}"</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            ${results.map(condition => `
                                <div class="condition-card bg-zinc-700/50 hover:bg-zinc-700 p-4 rounded-lg cursor-pointer transition-all duration-200 border border-zinc-600 hover:border-emerald-500" data-doc-id="${condition.id}">
                                    <h3 class="font-semibold text-lg text-white">${condition.condition}</h3>
                                    <p class="text-sm text-gray-400">${condition.specialty} (${condition.isCustom ? 'Módulo Pessoal' : condition.ficha})</p>
                                </div>
                            `).join('')}
                        </div>
                    `;
                    document.querySelectorAll('.condition-card').forEach(card => {
                        card.addEventListener('click', async () => {
                            const conditionDoc = await getConditionByDocId(card.dataset.docId);
                            if(conditionDoc) renderConditionDetails(conditionDoc);
                        });
                    });
                } else {
                    contentDisplay.innerHTML = `<p class="text-center text-gray-400 mt-16">Nenhum resultado encontrado para "${query}".</p>`;
                }
            }

            function switchFicha(newFicha, resetContent = true) {
                currentFicha = newFicha;
                fichaVerdeBtn.classList.toggle('active-ficha', newFicha === 'verde');
                fichaVermelhaBtn.classList.toggle('active-ficha', newFicha === 'vermelha');
                if (resetContent) {
                    renderSpecialties(newFicha);
                }
            }
            
            function toggleSidebar() {
                isSidebarOpen = !isSidebarOpen;
                if (isSidebarOpen) {
                    sidebar.classList.remove('-translate-x-full');
                } else {
                    sidebar.classList.add('-translate-x-full');
                }
            }
            
            async function loadLastView() {
                const lastViewJSON = localStorage.getItem('lastView');
                if (lastViewJSON) {
                    const lastView = JSON.parse(lastViewJSON);
                    const fichaToLoad = lastView.ficha || 'verde';
                    switchFicha(fichaToLoad, false);

                    if (lastView.docId) {
                        const conditionDoc = await getConditionByDocId(lastView.docId);
                        if (conditionDoc) {
                             await renderSpecialties(fichaToLoad);
                             renderConditionDetails(conditionDoc);
                        } else {
                             renderSpecialties(fichaToLoad);
                        }
                    } else if (lastView.specialty) {
                        await renderSpecialties(fichaToLoad);
                        renderConditions(lastView.specialty, lastView.isCustom);
                    } else {
                        renderSpecialties(fichaToLoad);
                    }
                } else {
                    switchFicha('verde');
                }
            }

            function setupCustomModules() {
                if(!isFirebaseConnected) return; // Só ativa se estiver online
                addModuleBtn.addEventListener('click', () => addModuleModal.classList.remove('hidden'));
                closeModuleModalBtn.addEventListener('click', () => addModuleModal.classList.add('hidden'));

                saveModuleBtn.addEventListener('click', async () => {
                    const specialty = document.getElementById('module-specialty').value.trim();
                    const condition = document.getElementById('module-condition').value.trim();
                    const content = document.getElementById('module-content').value.trim();
                    
                    if (!specialty || !condition) {
                        alert("Especialidade e Condição são campos obrigatórios.");
                        return;
                    }
                    
                    saveModuleBtn.disabled = true;
                    saveModuleBtn.innerText = "Salvando...";

                    try {
                        await addDoc(collection(db, `artifacts/${appId}/public/data/prescriptions`), {
                            specialty,
                            condition,
                            content,
                            prescriptions: [],
                            isCustom: true,
                            createdAt: serverTimestamp()
                        });
                        alert("Módulo salvo com sucesso!");
                        document.getElementById('module-form').reset();
                        addModuleModal.classList.add('hidden');
                        await renderSpecialties(currentFicha);
                    } catch (error) {
                        console.error("Erro ao salvar módulo:", error);
                        alert("Ocorreu um erro ao salvar o módulo.");
                    } finally {
                         saveModuleBtn.disabled = false;
                         saveModuleBtn.innerText = "Salvar Módulo";
                    }
                });
            }

            await migrateDatabaseToFirestore();
            await loadLastView(); 
            setupCustomModules();
        }

    </script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .sidebar { transition: transform 0.3s ease-in-out; }
        .main-content { transition: margin-left 0.3s ease-in-out; }
        .active-ficha {
            background-color: #3f3f46;
            box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
        }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }
        .gemini-btn {
            background-color: #374151; color: #d1d5db; padding: 0.6rem 1.2rem;
            border-radius: 0.5rem; font-weight: 500; transition: all 0.2s;
            display: flex; align-items: center; justify-content: center;
            border: 1px solid #4b5563;
        }
        .gemini-btn:hover { background-color: #4b5563; }
        .prose {
            color: #d1d5db;
        }
        .prose a {
            color: #34d399;
        }
        .prose strong {
            color: #f9fafb;
        }
    </style>
</head>
<body class="bg-zinc-900 text-gray-300">

    <div id="error-banner" class="hidden fixed bottom-0 left-0 right-0 bg-amber-600 text-white text-center p-2 z-50 text-sm"></div>
    <div id="migration-status" class="hidden fixed top-0 left-0 right-0 bg-emerald-500 text-white text-center p-2 z-50"></div>

    <!-- Sidebar / Navigation -->
    <aside id="sidebar" class="sidebar bg-zinc-800 w-72 fixed top-0 left-0 h-full shadow-lg p-4 z-20 transform -translate-x-full md:translate-x-0 border-r border-zinc-700 flex flex-col">
        <div class="flex items-center mb-6 pl-2">
             <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-emerald-400 mr-3" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"></path><path d="M12 8v4l2 1"></path><path d="m15.5 17.5-3-1.5-3 1.5"></path></svg>
            <h1 class="text-2xl font-bold text-white">HelpClin</h1>
        </div>
        <input type="text" id="search-bar" placeholder="Pesquisar..." class="w-full p-2 bg-zinc-700 border border-zinc-600 rounded-lg mb-4 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-emerald-500">
        <nav id="specialties-nav" class="overflow-y-auto flex-grow">
        </nav>
        <div class="mt-4">
            <button id="add-module-btn" class="w-full flex items-center justify-center p-3 rounded-lg text-gray-300 bg-zinc-700 hover:bg-emerald-600 hover:text-white transition-colors duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" /></svg>
                Adicionar Módulo
            </button>
        </div>
    </aside>

    <!-- Conteúdo Principal -->
    <main id="main-content" class="main-content md:ml-72 p-4 md:p-8">
        <!-- Cabeçalho -->
        <header class="flex justify-between items-center mb-8">
             <button id="menu-toggle" class="md:hidden p-2 rounded-md bg-zinc-700 text-gray-300">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7"></path></svg>
            </button>
            <div class="flex-grow flex justify-center">
                 <div class="flex justify-center gap-2 md:gap-4 rounded-xl p-1 bg-zinc-800 border border-zinc-700">
                    <button id="ficha-verde-btn" class="ficha-selector text-white font-semibold py-2 px-4 md:px-6 rounded-lg transition-all duration-300" data-ficha="verde">
                        Ficha Verde
                    </button>
                    <button id="ficha-vermelha-btn" class="ficha-selector text-white font-semibold py-2 px-4 md:px-6 rounded-lg transition-all duration-300" data-ficha="vermelha">
                        Ficha Amarela/Vermelha
                    </button>
                </div>
            </div>
            <div class="w-8"></div>
        </header>

        <!-- Área de Exibição de Conteúdo -->
        <div id="content-display" class="bg-zinc-800 p-6 md:p-8 rounded-xl shadow-lg border border-zinc-700 min-h-[75vh]">
        </div>
    </main>
    
    <!-- Modal do Gemini -->
    <div id="gemini-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-zinc-800 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] flex flex-col border border-zinc-700">
            <div class="flex justify-between items-center p-4 border-b border-zinc-700">
                <h3 id="gemini-modal-title" class="text-xl font-bold text-white flex items-center"></h3>
                <button id="gemini-modal-close" class="text-gray-400 hover:text-white text-3xl leading-none">&times;</button>
            </div>
            <div id="gemini-modal-content" class="p-6 overflow-y-auto">
                <div id="gemini-loading" class="text-center hidden">
                    <svg class="animate-spin h-8 w-8 text-emerald-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <p class="mt-2 text-gray-400">Gerando resposta...</p>
                </div>
                <div id="gemini-result" class="prose prose-invert max-w-none text-gray-300"></div>
            </div>
        </div>
    </div>

    <!-- Modal para Adicionar Módulo -->
     <div id="add-module-modal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 z-50 hidden">
        <div class="bg-zinc-800 rounded-xl shadow-2xl w-full max-w-xl border border-zinc-700">
            <div class="flex justify-between items-center p-4 border-b border-zinc-700">
                <h3 class="text-xl font-bold text-white">Adicionar Novo Módulo</h3>
                <button id="close-module-modal" class="text-gray-400 hover:text-white text-3xl">&times;</button>
            </div>
            <div class="p-6">
                <form id="module-form" class="space-y-4">
                    <input type="text" id="module-specialty" placeholder="Nome da Especialidade (ex: Cardiologia)" class="w-full p-2 bg-zinc-700 border border-zinc-600 rounded-lg text-white" required>
                    <input type="text" id="module-condition" placeholder="Nome da Condição (ex: Anafilaxia)" class="w-full p-2 bg-zinc-700 border border-zinc-600 rounded-lg text-white" required>
                    <textarea id="module-content" placeholder="Conteúdo do módulo (use quebras de linha para parágrafos)" rows="8" class="w-full p-2 bg-zinc-700 border border-zinc-600 rounded-lg text-white"></textarea>
                    <button type="button" id="save-module-btn" class="w-full gemini-btn bg-emerald-600 text-white hover:bg-emerald-700">Salvar Módulo</button>
                </form>
            </div>
        </div>
    </div>

</body>
</html>

